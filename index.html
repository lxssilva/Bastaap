<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bastaap - AI Pro</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Bebas+Neue&display=swap');

        :root {
            --bg-dark: #121212;
            --card-bg: #1e1e1e;
            --accent: #ffc107;
            --ai-accent: #8e44ad;
            --text-main: #ffffff;
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-dark);
            text-align: center;
            padding: 10px;
            color: var(--text-main);
            margin: 0;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            overflow-x: hidden;
        }

        h1 {
            font-family: 'Bebas Neue', sans-serif;
            font-size: clamp(3rem, 15vw, 5rem);
            color: var(--accent);
            margin: 10px 0;
            letter-spacing: 5px;
            text-transform: uppercase;
        }

        .card {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 20px;
            width: 100%;
            max-width: 500px;
            margin: 10px auto;
            border: 1px solid #333;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            flex-shrink: 0;
            position: relative;
            z-index: 10;
        }

        #category-box {
            background: #ffffff;
            color: #000000;
            padding: 30px 15px;
            border-radius: 12px;
            margin: 15px 0;
            min-height: 140px;
            display: flex;
            justify-content: center;
            align-items: center;
            border: 6px solid var(--accent);
            position: relative;
            overflow: hidden;
        }

        #full-category-text {
            font-family: 'Bebas Neue', cursive;
            font-size: clamp(1.5rem, 8vw, 2.2rem);
            line-height: 1.1;
            text-transform: uppercase;
            word-spacing: 3px;
            z-index: 1;
        }

        button.main-btn {
            background-color: var(--accent);
            color: #000;
            border: none;
            padding: 15px 20px;
            font-size: 1.1rem;
            font-weight: 900;
            text-transform: uppercase;
            border-radius: 12px;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
            transition: all 0.2s;
            box-shadow: 0 4px 0 #c79a00;
        }
        button.main-btn:active { 
            transform: translateY(2px); 
            box-shadow: 0 2px 0 #c79a00;
        }

        button.ai-btn {
            background-color: var(--ai-accent);
            color: white;
            box-shadow: 0 4px 0 #5b2c6f;
        }

        .setup-controls {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            justify-content: center;
        }

        input[type="text"], input[type="number"] {
            padding: 12px;
            border-radius: 8px;
            border: 2px solid #333;
            background: #2a2a2a;
            color: white;
            font-size: 16px;
            min-width: 0;
        }

        input[type="text"] { flex: 1; }

        input[type="color"] {
            -webkit-appearance: none;
            border: none;
            width: 45px;
            height: 45px;
            cursor: pointer;
            background: none;
            flex-shrink: 0;
        }
        input[type="color"]::-webkit-color-swatch {
            border-radius: 8px;
            border: 2px solid white;
        }

        .btn-add {
            background: #444;
            color: white;
            border: none;
            padding: 0 15px;
            border-radius: 8px;
            font-size: 20px;
            font-weight: bold;
        }

        .recent-players-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 15px;
            justify-content: center;
        }

        .recent-chip {
            background: #333;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            border: 1px solid #444;
        }

        .setup-list-item {
            display: flex;
            align-items: center;
            gap: 10px;
            background: #2a2a2a;
            padding: 10px 15px;
            border-radius: 10px;
            margin-bottom: 8px;
            font-weight: bold;
        }

        .color-dot {
            width: 15px;
            height: 15px;
            border-radius: 50%;
        }

        .player-score-btn {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #2a2a2a;
            padding: 15px 20px;
            border-radius: 15px;
            border: none;
            width: 100%;
            cursor: pointer;
            border-left: 8px solid transparent;
            color: white;
            margin-bottom: 10px;
        }

        .player-name-label {
            font-weight: 900;
            font-size: clamp(1rem, 5vw, 1.3rem);
            text-transform: uppercase;
        }

        .score-num {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 2.5rem;
            color: var(--accent);
        }

        #dispute-box {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            max-width: 400px;
            z-index: 100;
            background: #222;
            border: 2px solid var(--ai-accent);
            padding: 20px;
            border-radius: 15px;
        }

        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 90;
        }

        .hidden { display: none; }

        /* Confeti Container */
        #confetti-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 999;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <canvas id="confetti-canvas"></canvas>
    <h1>BASTAAP</h1>

    <!-- REGISTRO -->
    <div id="setup-screen" class="card">
        <h3 style="margin-top:0">JUGADORES</h3>
        
        <div id="recent-players-section" class="hidden">
            <p style="font-size: 0.7rem; color: #888; margin-bottom: 8px; text-transform: uppercase;">Recientes (Toca para a√±adir):</p>
            <div id="recent-players-list" class="recent-players-container"></div>
        </div>

        <div class="setup-controls">
            <input type="text" id="new-player-name" placeholder="Nombre..." autocomplete="off">
            <input type="color" id="new-player-color" value="#ffc107">
            <button class="btn-add" onclick="addPlayer()">+</button>
        </div>
        
        <div id="setup-list"></div>
        
        <hr style="border:0; border-top:1px solid #444; margin: 15px 0;">
        <label style="font-size: 0.8rem; color: #888;">PUNTOS PARA GANAR:</label>
        <input type="number" id="winning-score-input" value="10" style="width: 60px; margin-bottom: 15px;">
        <button class="main-btn" onclick="startGame()">¬°COMENZAR!</button>
    </div>

    <!-- JUEGO -->
    <div id="game-screen" class="card hidden">
        <div style="display:flex; justify-content:space-between; color:#888; font-weight:bold; font-size: 0.8rem; margin-bottom: 5px;">
            <span id="round-counter">RONDA 0</span>
            <span onclick="resetGame()" style="cursor:pointer; text-decoration: underline;">REINICIAR</span>
        </div>
        
        <div id="category-box">
            <div id="full-category-text">TOCA EL BOT√ìN PARA EMPEZAR</div>
        </div>
        
        <button class="main-btn" onclick="generateCategory()">üé≤ CATEGOR√çA AL AZAR</button>
        <button id="ai-gen-btn" class="main-btn ai-btn" onclick="generateAiCategory()">‚ú® GENERACI√ìN M√ÅGICA</button>

        <div style="margin-top: 20px; display: flex; gap: 10px;">
            <button class="main-btn" style="background:#444; color:white; font-size:0.8rem; padding: 10px; box-shadow:none;" onclick="openDispute()">‚öñÔ∏è DISPUTA IA</button>
        </div>

        <p style="font-size: 0.8rem; color: #888; margin: 15px 0 5px 0;">Toca el jugador para sumar +1</p>
        <div id="players-container"></div>
    </div>

    <!-- DISPUTA MODAL -->
    <div id="dispute-overlay" class="overlay hidden"></div>
    <div id="dispute-box" class="hidden">
        <h3 style="color: var(--ai-accent); margin-top:0;">‚ú® JUEZ IA</h3>
        <p style="font-size:0.9rem;">¬øLa palabra es v√°lida para la categor√≠a?</p>
        <input type="text" id="dispute-word" placeholder="Ej: Tomate" style="width:100%; margin-bottom:10px;">
        <div id="dispute-result" style="font-size:0.8rem; margin: 10px 0; color: #ccc; min-height: 40px;"></div>
        <div style="display:flex; gap:10px;">
            <button class="main-btn ai-btn" style="flex:1;" onclick="resolveDispute()" id="resolve-btn">CONSULTAR</button>
            <button class="main-btn" style="flex:1; background:#444; color:white; box-shadow:none;" onclick="closeDispute()">CERRAR</button>
        </div>
    </div>

    <!-- GANADOR -->
    <div id="winner-message" class="card hidden">
        <h1 style="font-size: clamp(4rem, 20vw, 6rem);">¬°GAN√ì!</h1>
        <div id="winner-display" style="font-size: 2.5rem; font-weight: bold; margin: 20px 0; text-transform: uppercase;"></div>
        <button class="main-btn" onclick="resetGame()">VOLVER A JUGAR</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        let user = null;
        let recentPlayers = [];
        let players = [];
        let round = 0;
        let winningScore = 10;
        let currentCategoryText = "";
        const apiKey = ""; 

        // --- CONFETTI LOGIC ---
        const canvas = document.getElementById('confetti-canvas');
        const ctx = canvas.getContext('2d');
        let confetti = [];
        let animationId = null;

        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        class Particle {
            constructor() {
                this.x = Math.random() * canvas.width;
                this.y = Math.random() * canvas.height - canvas.height;
                this.size = Math.random() * 8 + 4;
                this.color = `hsl(${Math.random() * 360}, 80%, 60%)`;
                this.speed = Math.random() * 3 + 2;
                this.angle = Math.random() * 6;
                this.rotation = Math.random() * 0.2 - 0.1;
            }
            update() {
                this.y += this.speed;
                this.angle += this.rotation;
                if (this.y > canvas.height) {
                    this.y = -20;
                    this.x = Math.random() * canvas.width;
                }
            }
            draw() {
                ctx.save();
                ctx.translate(this.x, this.y);
                ctx.rotate(this.angle);
                ctx.fillStyle = this.color;
                ctx.fillRect(-this.size/2, -this.size/2, this.size, this.size);
                ctx.restore();
            }
        }

        function startConfetti() {
            confetti = Array.from({ length: 150 }, () => new Particle());
            function animate() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                confetti.forEach(p => {
                    p.update();
                    p.draw();
                });
                animationId = requestAnimationFrame(animate);
            }
            animate();
        }

        function stopConfetti() {
            if (animationId) cancelAnimationFrame(animationId);
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }

        // --- FIREBASE AUTH ---
        const initAuth = async () => {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
            } else {
                await signInAnonymously(auth);
            }
        };
        initAuth();

        onAuthStateChanged(auth, (u) => {
            user = u;
            if (user) loadRecentPlayers();
        });

        async function loadRecentPlayers() {
            if (!user) return;
            const docRef = doc(db, 'artifacts', appId, 'users', user.uid, 'settings', 'players');
            try {
                const snap = await getDoc(docRef);
                if (snap.exists()) {
                    recentPlayers = snap.data().list || [];
                    renderRecentPlayers();
                }
            } catch (e) {}
        }

        async function saveToRecent(newPlayers) {
            if (!user) return;
            let updated = [...newPlayers.map(p => ({name: p.name, color: p.color})), ...recentPlayers];
            const unique = [];
            const names = new Set();
            for (const p of updated) {
                if (!names.has(p.name.toUpperCase())) {
                    names.add(p.name.toUpperCase());
                    unique.push(p);
                }
            }
            recentPlayers = unique.slice(0, 8);
            await setDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'settings', 'players'), { list: recentPlayers });
        }

        // --- GLOBAL FUNCTIONS ---
        window.addPlayer = function() {
            const nameInp = document.getElementById('new-player-name');
            const colorInp = document.getElementById('new-player-color');
            const name = nameInp.value.trim();
            if (name) {
                players.push({ name: name, color: colorInp.value, score: 0 });
                renderSetupList();
                nameInp.value = ''; nameInp.focus();
            }
        };

        window.addRecentPlayer = function(index) {
            const p = recentPlayers[index];
            if (!players.find(curr => curr.name.toUpperCase() === p.name.toUpperCase())) {
                players.push({ name: p.name, color: p.color, score: 0 });
                renderSetupList();
            }
        };

        function renderRecentPlayers() {
            const container = document.getElementById('recent-players-list');
            const section = document.getElementById('recent-players-section');
            if (recentPlayers.length === 0) {
                section.classList.add('hidden');
                return;
            }
            section.classList.remove('hidden');
            container.innerHTML = recentPlayers.map((p, i) => `
                <div class="recent-chip" onclick="addRecentPlayer(${i})">
                    <div class="color-dot" style="background:${p.color}"></div>
                    ${p.name}
                </div>
            `).join('');
        }

        function renderSetupList() {
            document.getElementById('setup-list').innerHTML = players.map(p => `
                <div class="setup-list-item"><div class="color-dot" style="background:${p.color}"></div><span>${p.name}</span></div>
            `).join('');
        }

        window.startGame = function() {
            if (players.length < 1) return;
            saveToRecent(players);
            winningScore = parseInt(document.getElementById('winning-score-input').value) || 10;
            document.getElementById('setup-screen').classList.add('hidden');
            document.getElementById('game-screen').classList.remove('hidden');
            renderScoreboard();
        };

        async function callGemini(prompt, systemPrompt = "Eres un asistente de juegos de mesa divertido.") {
            let delay = 1000;
            for (let i = 0; i < 5; i++) {
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: prompt }] }],
                            systemInstruction: { parts: [{ text: systemPrompt }] }
                        })
                    });
                    const data = await response.json();
                    return data.candidates?.[0]?.content?.parts?.[0]?.text;
                } catch (e) {
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 2;
                }
            }
            return null;
        }

        window.generateCategory = function() {
            round++;
            document.getElementById('round-counter').innerText = "RONDA " + round;
            const display = document.getElementById('full-category-text');
            display.innerText = "ESPERA...";
            
            const subjects = [
                { text: "Un animal", type: "physical" }, { text: "Una comida", type: "physical" },
                { text: "Ropa", type: "physical" }, { text: "Un lugar", type: "physical" },
                { text: "Un objeto", type: "physical" }, { text: "Un regalo", type: "physical" },
                { text: "Un veh√≠culo", type: "physical" }, { text: "Fruta o verdura", type: "physical" },
                { text: "Parte del cuerpo", type: "physical" }, { text: "Algo de cocina", type: "physical" },
                { text: "Una canci√≥n", type: "abstract" }, { text: "Una pel√≠cula", type: "abstract" },
                { text: "Una excusa", type: "abstract" }, { text: "Un insulto", type: "abstract" },
                { text: "Una mentira", type: "abstract" }, { text: "Una aplicaci√≥n", type: "abstract" },
                { text: "Un miedo", type: "abstract" }, { text: "Una profesi√≥n", type: "abstract" },
                { text: "Un famoso", type: "physical" }, { text: "Un villano", type: "physical" }
            ];
            const conditions = [
                { text: "que huela mal", reqPhysical: true }, { text: "en la basura", reqPhysical: true },
                { text: "que sea pegajoso", reqPhysical: true }, { text: "en el bolsillo", reqPhysical: true },
                { text: "en un hospital", reqPhysical: true }, { text: "que flote", reqPhysical: true },
                { text: "con cuchara", reqPhysical: true }, { text: "peludo", reqPhysical: true },
                { text: "muy pesado", reqPhysical: true }, { text: "ruidoso al caer", reqPhysical: true },
                { text: "para tu ex", reqPhysical: false }, { text: "que cueste caro", reqPhysical: false },
                { text: "en un apocalipsis", reqPhysical: false }, { text: "que de verg√ºenza", reqPhysical: false },
                { text: "que sea ilegal", reqPhysical: false }, { text: "para enamorar", reqPhysical: false },
                { text: "al estar triste", reqPhysical: false }, { text: "con la letra de hoy", reqPhysical: false },
                { text: "que odies", reqPhysical: false }, { text: "que de risa", reqPhysical: false }
            ];

            setTimeout(() => {
                const subj = subjects[Math.floor(Math.random() * subjects.length)];
                const validConds = conditions.filter(c => !c.reqPhysical || subj.type === 'physical');
                const cond = validConds[Math.floor(Math.random() * validConds.length)];
                currentCategoryText = `${subj.text} ${cond.text}`.toUpperCase();
                display.innerText = currentCategoryText;
            }, 150);
        };

        window.generateAiCategory = async function() {
            const btn = document.getElementById('ai-gen-btn');
            const display = document.getElementById('full-category-text');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading-spinner"></span>';
            display.innerText = "INSPIR√ÅNDOSE...";

            const prompt = "Genera una categor√≠a √∫nica para el juego 'Basta'. M√°ximo 8 palabras en espa√±ol. Ej: 'Algo que un astronauta olvidar√≠a'. Solo el texto en may√∫sculas.";
            const result = await callGemini(prompt, "Genera solo el texto de la categor√≠a.");
            if (result) {
                round++;
                document.getElementById('round-counter').innerText = "RONDA " + round;
                currentCategoryText = result.trim().toUpperCase();
                display.innerText = currentCategoryText;
            } else {
                display.innerText = "ERROR DE CONEXI√ìN";
            }
            btn.disabled = false;
            btn.innerHTML = '‚ú® GENERACI√ìN M√ÅGICA';
        };

        window.openDispute = function() {
            document.getElementById('dispute-overlay').classList.remove('hidden');
            document.getElementById('dispute-box').classList.remove('hidden');
            document.getElementById('dispute-word').value = "";
            document.getElementById('dispute-result').innerText = "";
        };

        window.closeDispute = function() {
            document.getElementById('dispute-overlay').classList.add('hidden');
            document.getElementById('dispute-box').classList.add('hidden');
        };

        window.resolveDispute = async function() {
            const word = document.getElementById('dispute-word').value.trim();
            if (!word || !currentCategoryText) return;
            const btn = document.getElementById('resolve-btn');
            const resBox = document.getElementById('dispute-result');
            btn.disabled = true;
            resBox.innerText = "Pensando...";
            const prompt = `Categor√≠a: "${currentCategoryText}". Palabra: "${word}". ¬øV√°lida? Responde S√ç o NO y raz√≥n corta.`;
            const result = await callGemini(prompt, "Eres un juez de juego de mesa.");
            resBox.innerText = result || "Error del juez.";
            btn.disabled = false;
        };

        window.givePoint = function(index) {
            players[index].score++;
            if (players[index].score >= winningScore) {
                document.getElementById('game-screen').classList.add('hidden');
                document.getElementById('winner-message').classList.remove('hidden');
                const winDisplay = document.getElementById('winner-display');
                winDisplay.innerText = players[index].name;
                winDisplay.style.color = players[index].color;
                startConfetti();
            } else {
                renderScoreboard();
            }
        };

        function renderScoreboard() {
            const container = document.getElementById('players-container');
            container.innerHTML = '';
            players.forEach((player, index) => {
                const btn = document.createElement('button');
                btn.className = 'player-score-btn';
                btn.style.borderLeftColor = player.color;
                btn.onclick = () => window.givePoint(index);
                btn.innerHTML = `<div class="player-name-label" style="color:${player.color}">${player.name.toUpperCase()}</div><div class="score-num">${player.score}</div>`;
                container.appendChild(btn);
            });
        }

        window.resetGame = function() {
            stopConfetti();
            players = []; round = 0;
            document.getElementById('setup-list').innerHTML = '';
            document.getElementById('winner-message').classList.add('hidden');
            document.getElementById('game-screen').classList.add('hidden');
            document.getElementById('setup-screen').classList.remove('hidden');
            document.getElementById('full-category-text').innerText = "TOCA EL BOT√ìN PARA EMPEZAR";
            loadRecentPlayers();
        };

        document.getElementById("new-player-name").addEventListener("keypress", (e) => {
            if (e.key === "Enter") window.addPlayer();
        });
    </script>
</body>
</html>
